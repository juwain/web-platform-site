---
title: "Паттерн Module (Модуль), практика: кэш с WeakMap"
---

Представьте, что вы разрабатываете приложение для анализа данных.

У вас есть объект, где ключи — это ID пользователей, а значения — массивы с их ответами в опроснике:

```js
const surveyData = {
  user1: [5, 3, 4, 2, 5], // Ответы пользователя 1
  user2: [1, 2, 3, 4, 5], // Ответы пользователя 2
  // ...
};
```

В приложении нужно реализовать функцию, которая принимает этот объект, выполняет определённые «тяжёлые» вычисления для каждого значения и возвращает массив с результатами. К примеру, для каждого пользователя надо вычислить средний балл по его ответам и вернуть массив полученных значений с баллами всех пользователей.

Логично будет вынести эту функцию в отдельный модуль, откуда она будет экспортироваться:

```js
// module.js

function processSurveyData(obj) {
  // Тяжёлые вычисления: массив средних баллов для каждого пользователя
  const result = Object.values(obj).map((value) => calculateAverage(value));

  return result;
}

export { processSurveyData };
```

А в модуле-потребителе эта функция будет импортироваться и запускаться с данными пользователей:

```js
// App.js

import { processSurveyData } from "./module.js";

const surveyData = {
  user1: [1, 2, 3, 4, 5],
  user2: [7, 1, 5, 3, 2],
  // ...
};

const result = processSurveyData(surveyData);
```

А чтобы не выполнять повторно вычисления для одного и того же объекта, можно организовать внутри `module.js` кэш, о котором ничего не будет известно снаружи.
Тогда при повторном вызове функции `processSurveyData` результат не будет вычисляться заново, а ранее вычисленное значение просто возьмётся из кэша, и функция отработает быстрее.

Подходящий инструмент для организации кэша – структура данных `WeakMap`. `WeakMap`, как и обычный `Map`, умеет хранить пары ключ-значение, но ключом в нём может быть только объект:

```js
const obj = { test: 1 };
const value = 2;
const cache = new WeakMap();

cache.set(obj, value);
// cache: [key: {test: 1}, value: 2]
```

У `WeakMap` есть такая полезная особенность, что если объект из ключа более не существует в памяти, то значение, привязанное к нему, удаляется из памяти garbage collector-ом; это и можно использовать для организации кеша, который автоматически подчищается, когда закешированные объекты больше не существуют.

В нашем случае, после выполнения вычислений внутри `processSurveyData` результат нужно записать в кэш перед возвращением, а перед вычислением проверять наличие уже вычисленного значения в кэше, и в случае его наличия, сразу же возвращать:

```js
// проверка наличия вычисленного значения в кэше перед вычислением
if (cache.has(obj)) {
  return cache.get(obj);
}

const result = /* вычисление */;

// запись вычисленного значения в кэш
cache.set(obj, result);

return result;
```

Реализуйте в модуле `module.js` внутри функции `processSurveyData` вычисление массива средних баллов для каждого пользователя с кешированием результата с помощью `WeakMap`.
